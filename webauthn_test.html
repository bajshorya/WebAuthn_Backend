<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebAuthn Registration & Authentication Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
      }
      h2 {
        color: #333;
      }
      input {
        padding: 8px;
        margin: 5px 0;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px 5px 5px 0;
      }
      button:hover {
        background-color: #45a049;
      }
      button.danger {
        background-color: #f44336;
      }
      button.danger:hover {
        background-color: #da190b;
      }
      #output {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        word-break: break-all;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
    </style>
  </head>
  <body>
    <h1>WebAuthn Test Client</h1>

    <div class="container">
      <h2>1. Register New Passkey</h2>
      <input
        type="text"
        id="registerUsername"
        placeholder="Enter username"
        value="testuser"
      />
      <button onclick="startRegistration()">Start Registration</button>
      <button onclick="finishRegistration()" class="danger">
        Finish Registration
      </button>
      <div id="output"></div>
    </div>

    <div class="container">
      <h2>2. Authenticate with Passkey</h2>
      <input
        type="text"
        id="loginUsername"
        placeholder="Enter username"
        value="testuser"
      />
      <button onclick="startAuthentication()">Start Authentication</button>
      <button onclick="finishAuthentication()" class="danger">
        Finish Authentication
      </button>
      <div id="output"></div>
    </div>

    <script>
      const API_BASE = "http://localhost:8080";
      let registrationOptions = null;
      let authenticationOptions = null;
      const output = document.getElementById("output");

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "error" ? "error" : type === "success" ? "success" : "info";
        output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        output.scrollTop = output.scrollHeight;
      }

      function clearOutput() {
        output.innerHTML = "";
      }

      // ===== REGISTRATION FLOW =====
      async function startRegistration() {
        clearOutput();
        const username = document.getElementById("registerUsername").value;
        if (!username) {
          log("Please enter a username", "error");
          return;
        }

        try {
          log(`Starting registration for user: ${username}`);
          const response = await fetch(
            `${API_BASE}/register_start/${username}`,
            {
              method: "POST",
              credentials: "include",
            },
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          registrationOptions = await response.json();
          log("✓ Registration options received from server", "success");
          log(JSON.stringify(registrationOptions, null, 2));

          // Convert base64 strings to ArrayBuffers
          registrationOptions.publicKey.challenge = Uint8Array.from(
            atob(
              registrationOptions.publicKey.challenge
                .replace(/-/g, "+")
                .replace(/_/g, "/"),
            ),
            (c) => c.charCodeAt(0),
          );
          registrationOptions.publicKey.user.id = Uint8Array.from(
            atob(
              registrationOptions.publicKey.user.id
                .replace(/-/g, "+")
                .replace(/_/g, "/"),
            ),
            (c) => c.charCodeAt(0),
          );

          log(
            "Click 'Finish Registration' to complete with your authenticator",
            "info",
          );
        } catch (error) {
          log(`Error: ${error.message}`, "error");
        }
      }

      async function finishRegistration() {
        if (!registrationOptions) {
          log("Please start registration first", "error");
          return;
        }

        try {
          log("Waiting for authenticator...");

          // Use navigator.credentials.create() to generate credential
          const credential = await navigator.credentials.create({
            publicKey: registrationOptions.publicKey,
          });

          if (!credential) {
            throw new Error("Credential creation was cancelled");
          }

          log("✓ Credential generated", "success");

          // Prepare credential for sending to server
          const attestationObject = new Uint8Array(
            credential.response.attestationObject,
          );
          const clientDataJSON = new Uint8Array(
            credential.response.clientDataJSON,
          );

          const credentialJSON = {
            id: credential.id,
            rawId: btoa(
              String.fromCharCode(...new Uint8Array(credential.rawId)),
            )
              .replace(/\+/g, "-")
              .replace(/\//g, "_")
              .replace(/=/g, ""),
            response: {
              attestationObject: btoa(String.fromCharCode(...attestationObject))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=/g, ""),
              clientDataJSON: btoa(String.fromCharCode(...clientDataJSON))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=/g, ""),
            },
            type: credential.type,
          };

          log("Sending credential to server...");
          const response = await fetch(`${API_BASE}/register_finish`, {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(credentialJSON),
          });

          // Try to parse JSON regardless of status
          let result;
          try {
            result = await response.json();
          } catch (jsonError) {
            // If JSON parsing fails, use the status text
            result = {
              status: response.ok ? "success" : "error",
              message: response.statusText || "Unknown error",
            };
          }

          if (!response.ok) {
            throw new Error(
              result.message || `HTTP error! status: ${response.status}`,
            );
          }

          log("✓ Registration successful!", "success");
          log(JSON.stringify(result, null, 2));
          registrationOptions = null;
        } catch (error) {
          log(`Error: ${error.message}`, "error");
        }
      }
      // ===== AUTHENTICATION FLOW =====
      async function startAuthentication() {
        clearOutput();
        const username = document.getElementById("loginUsername").value;
        if (!username) {
          log("Please enter a username", "error");
          return;
        }

        try {
          log(`Starting authentication for user: ${username}`);
          const response = await fetch(`${API_BASE}/login_start/${username}`, {
            method: "POST",
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          authenticationOptions = await response.json();
          log("✓ Authentication options received from server", "success");
          log(JSON.stringify(authenticationOptions, null, 2));

          // Convert base64 strings to ArrayBuffers
          authenticationOptions.publicKey.challenge = Uint8Array.from(
            atob(
              authenticationOptions.publicKey.challenge
                .replace(/-/g, "+")
                .replace(/_/g, "/"),
            ),
            (c) => c.charCodeAt(0),
          );

          if (authenticationOptions.publicKey.allowCredentials) {
            authenticationOptions.publicKey.allowCredentials.forEach((cred) => {
              cred.id = Uint8Array.from(
                atob(cred.id.replace(/-/g, "+").replace(/_/g, "/")),
                (c) => c.charCodeAt(0),
              );
            });
          }

          log(
            "Click 'Finish Authentication' to complete with your authenticator",
            "info",
          );
        } catch (error) {
          log(`Error: ${error.message}`, "error");
        }
      }
      async function finishAuthentication() {
        if (!authenticationOptions) {
          log("Please start authentication first", "error");
          return;
        }

        try {
          log("Waiting for authenticator...");

          // Use navigator.credentials.get() to authenticate
          const assertion = await navigator.credentials.get({
            publicKey: authenticationOptions.publicKey,
          });

          if (!assertion) {
            throw new Error("Authentication was cancelled");
          }

          log("✓ Assertion generated", "success");

          // Prepare assertion for sending to server
          const authenticatorData = new Uint8Array(
            assertion.response.authenticatorData,
          );
          const clientDataJSON = new Uint8Array(
            assertion.response.clientDataJSON,
          );
          const signature = new Uint8Array(assertion.response.signature);

          const assertionJSON = {
            id: assertion.id,
            rawId: btoa(String.fromCharCode(...new Uint8Array(assertion.rawId)))
              .replace(/\+/g, "-")
              .replace(/\//g, "_")
              .replace(/=/g, ""),
            response: {
              authenticatorData: btoa(String.fromCharCode(...authenticatorData))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=/g, ""),
              clientDataJSON: btoa(String.fromCharCode(...clientDataJSON))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=/g, ""),
              signature: btoa(String.fromCharCode(...signature))
                .replace(/\+/g, "-")
                .replace(/\//g, "_")
                .replace(/=/g, ""),
            },
            type: assertion.type,
          };

          log("Sending assertion to server...");
          const response = await fetch(`${API_BASE}/login_finish`, {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(assertionJSON),
          });

          // Try to parse JSON regardless of status
          let result;
          try {
            result = await response.json();
          } catch (jsonError) {
            // If JSON parsing fails, use the status text
            result = {
              status: response.ok ? "success" : "error",
              message: response.statusText || "Unknown error",
            };
          }

          if (!response.ok) {
            throw new Error(
              result.message || `HTTP error! status: ${response.status}`,
            );
          }

          log("✓ Authentication successful!", "success");
          log(JSON.stringify(result, null, 2));
          authenticationOptions = null;
        } catch (error) {
          log(`Error: ${error.message}`, "error");
        }
      }
    </script>
  </body>
</html>
